<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <title>学生信息管理</title>
        <link rel="stylesheet" href="./layer/theme/default/layer.css">
        <link rel="stylesheet" type="text/css" href="./css/reponse.css">
        <link rel="stylesheet" type="text/css" href="./css/lib/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="./css/custom.css">
        <style type="text/css">
		.alertceng{
			background: #FFFFFF;
			padding: 10px;
			display: none;
		}
		.alertceng span.title{
			margin-right: 10px;
		}
        </style>
    </head>
    <body>
        <div class="layui-fluid layadmin-homepage-fluid" style="background: #fff;width:90%;margin:0 auto;">
            <div id="page">
                <legend>证书查询</legend>
                <div class="control-group">
                    <div class="controls">
                        <input
                            id="input_search"
                            name="input_search"
                            type="text"
                            class="input-xlarge"
                            placeholder="search"
                        >
                        <label id="searchWarn"></label>
                        <button
                            type="button"
                            class="layui-btn"
                            id="search"
                            onclick="return search(document.getElementById('input_search').value);"
                        >公司名/用户/邮箱查询</button>
                        <!--class="layui-btn"-->
                        <!--  -->
                        <button
                            type="button"
                            class="layui-btn"
                            id="searchAll"
                            onclick="return search('all');"
                        >列出所有</button>
                        <table border="1" width="2000">
                            <thead>
                                <tr>
                                    <th>序列号</th>
                                    <th>邮箱</th>
                                    <th>签名算法</th>
                                    <th>加密算法</th>
                                    <th>申请日期</th>
                                    <th>有效期至</th>
                                    <th>用户</th>
                                    <th>证书下载</th>
                                    <!--<th>验证签名</th>-->
                                </tr>
                            </thead>
                            <tbody id="tbMain"></tbody>
                        </table>
                    </div>
                </div>
                <table id="search_table" class="reponsetable"></table>
            </div>
        </div>
    </body>
    <!--<script src="https://www.jq22.com/jquery/jquery-1.10.2.js"></script>-->
    <!--<script src="js/jquery.basictable.min.js"></script>-->
    <script src="assets/js/jquery-1.11.1.min.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/reponsetable.min.js"></script>
    <script src="layer/layer.js"></script>
    <script src="assets/js/jsencrypt.min.js"></script>
    <script src="assets/js/crypto-js.js"></script>
    <script type="text/javascript">
	function encryptByRSA(string, key) {
		if(key==0||key=='')
			key = 'MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCztkK+sbF4LzuKPshL9DmKbMq6mvvT7s+GVVmURiZNC8m4AwheBDje4RTdbDXqnhZSSS8MtziszfWPhvf1q3SnpkTa7G9+U8p835UG7SQSH6f3mOrJWMHqyYzDyOnNKc/V5am72D6qNgjwlr5FAHj2O3RstdaIcRW+HPuNjNNGqwIDAQAB';
		let jsencrypt = new JSEncrypt();
		jsencrypt.setPublicKey(key);
		return jsencrypt.encrypt(string);
	}
	function getAesKey(len) {
		//len = len || 32;
		var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678'; /****默认去掉了容易混淆的字符oOLl,9gq,Vv,Uu,I1****/ 　　
		var maxPos = $chars.length;　　
		var keyStr = '';
		for(i = 0; i < len; i++) {
			keyStr += $chars.charAt(Math.floor(Math.random() * maxPos));
		}
		return keyStr;
	}
	function encryptByAES(string, key,ivstr) {
		//key = '1234567890123456';
		let ckey = CryptoJS.enc.Utf8.parse(key);
		let encrypted = CryptoJS.AES.encrypt(string, ckey, {
			mode: CryptoJS.mode.CBC,
			padding: CryptoJS.pad.Pkcs7,
			iv:CryptoJS.enc.Utf8.parse(ivstr)
	}); 
		return encrypted.toString() // base64
		//return encrypted.ciphertext.toString();//hex
	}
	function decryptByAES(string, key, ivstr) {
		let ckey = CryptoJS.enc.Utf8.parse(key);
		let decrypted = CryptoJS.AES.decrypt(string, ckey, {
			mode: CryptoJS.mode.CBC,
			padding: CryptoJS.pad.Pkcs7,
			iv: CryptoJS.enc.Utf8.parse(ivstr)
		});
		var resultStr = CryptoJS.enc.Utf8.stringify(decrypted);
		return resultStr;
	}

	function getTableRow(cer){
		var row = document.createElement('tr');

		var col_serial = document.createElement('td');
		col_serial.innerHTML = cer['serialNumber'];
		row.appendChild(col_serial);

		var col_email = document.createElement('td');
		col_email.innerHTML=cer['email'];
		row.appendChild(col_email);

		var col_signAlgori = document.createElement('td');
		col_signAlgori.innerHTML = cer['signAlgori'];
		row.appendChild(col_signAlgori);

		var col_encAlori = document.createElement('td');
		col_encAlori.innerHTML = cer['encAlgori'];
		row.appendChild(col_encAlori); 

		var col_validTimeFrom = document.createElement('td');
		col_validTimeFrom.innerHTML = cer['validTimeFrom'];
		row.appendChild(col_validTimeFrom);

		var col_validTimeTo = document.createElement('td');
		col_validTimeTo.innerHTML = cer['validTimeTo'];
		row.appendChild(col_validTimeTo);

		var col_user = document.createElement('td');
		col_user.innerHTML = cer['user'];
		row.appendChild(col_user);

		var col_cer_download = document.createElement('td');
		var data_array = new Array(1);
		var data = JSON.stringify(cer);
		data_array.push(data);
		let file = new File(data_array,'certificate'+cer['user']+".mycer");
		let atag = document.createElement('a');
		atag.download = file.name;
		let href = URL.createObjectURL(file);
		atag.href = href;
		atag.text="download";
		var o = document.createElement('div');
		o.appendChild(atag);
		console.log(o.innerHTML);
		col_cer_download.innerHTML=o.innerHTML;
		row.appendChild(col_cer_download);

		return row;
	}
	
	var flag = 1;
	function search(input) {	//根据学号和姓名查询
		if(input==null||input.length==0){
			alert("查询框不能为空");
			return false;
		}
		
		var tbody = document.getElementById('tbMain');
		
		var key_str = getAesKey(32);
		var key = encryptByRSA(key_str,0);
		
		var iv_str = getAesKey(16);
		var iv = encryptByRSA(iv_str,0);
		
		var input_enc = encryptByAES(input,key_str,iv_str);

		var mac = CryptoJS.SHA512(key+iv+input_enc);

		xmlhttp  = new XMLHttpRequest();
		xmlhttp.open("POST","/CA/request_certificate/php/query_certificate.php",false);
		xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		xmlhttp.send("key="+encodeURIComponent(key)+"&iv="+encodeURIComponent(iv)+"&payload="+encodeURIComponent(input_enc)+"&mac="+encodeURIComponent(mac));

		var data = xmlhttp.responseText;
		if(data[0]!="{"){
			alert(data);
			return false;
		}
		else{
			var data_arr = JSON.parse(data);
			var iv = data_arr['iv'];
			var mac_trans = data_arr['mac'];
			var payload = data_arr['payload'];

			var mac_compute = CryptoJS.SHA512(iv+payload);
			if(mac_compute!=mac_trans){
				alert("Response mac invaild");
				return false;
			}
			else {
				var payload_json = decryptByAES(payload,key_str,iv);
				console.log(payload_json);
				var payload_arr = JSON.parse(payload_json);
				var maxindex = parseInt(payload_arr['num']);
				var i = 1;
				while(i<=maxindex){
					console.log(payload_arr[i.toString()]);
					var cer_arr = JSON.parse(payload_arr[i.toString()]);
					//add cer to table
					var row = getTableRow(cer_arr);
					//console.log(row);
					tbody.appendChild(row);
					i+=1;
				}
			}
		}
	}
    </script>
</html>
